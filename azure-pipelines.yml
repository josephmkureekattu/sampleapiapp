# Deploy to Azure Kubernetes Service
# Build and push image to Azure Container Registry; Deploy to Azure Kubernetes Service
# https://docs.microsoft.com/azure/devops/pipelines/languages/docker

trigger: none
#- master

resources:
- repo: self

variables:

  # Container registry service connection established during pipeline creation
  dockerRegistryServiceConnection: 'a2fd800b-c2eb-42dc-bee0-968108d219d8'
  imageRepository: 'josephmkureekattusampleapiapp'
  containerRegistry: 'testreg22.azurecr.io'
  dockerfilePath: '**/Dockerfile'
  tag: '$(Build.BuildId)'
  imagePullSecret: 'testreg2219566f44-auth'
  CONTAINER-REPO: 'testreg22.azurecr.io'

  # Agent VM image name
  vmImageName: 'ubuntu-latest'


stages:
- stage: Build
  displayName: Build stage
  jobs:
  - job: Build
    displayName: Build
    pool:
      vmImage: $(vmImageName)
    steps:
    - task: Docker@2
      displayName: Build and push an image to container registry
      inputs:
        command: buildAndPush
        repository: $(imageRepository)
        dockerfile: $(dockerfilePath)
        containerRegistry: $(dockerRegistryServiceConnection)
        tags: |
          $(tag)                
    - upload: manifests
      artifact: manifests
    - task: CopyFiles@2
      inputs:
        contents: $(build.sourcesDirectory)/kubedeployconfigs/*.*
        targetFolder: $(build.artifactStagingDirectory)
    - task: PublishBuildArtifacts@1
      inputs:
        pathtoPublish: $(build.artifactStagingDirectory)
        artifactName: drop

- stage: Deploy
  displayName: Deploy stage
  dependsOn: Build

  jobs:
  - deployment: Deploy
    displayName: Deploy
    pool:
      vmImage: $(vmImageName)
    environment: 'dsfsdfsdf.default'
    strategy:
      runOnce:
        deploy:
          steps:
          - task: KubernetesManifest@0
            displayName: Create imagePullSecret
            inputs:
              action: createSecret
              secretName: $(imagePullSecret)
              dockerRegistryEndpoint: $(dockerRegistryServiceConnection)          
          - task: Bash@3
            inputs:
              targetType: 'inline'
              script: |
                sed -i -e ''s/__CONTAINER-REPO__/$(containerRegistry)/''  $(Pipeline.Workspace)/drop/kubedeployconfigs/kubedeployconfigs.yaml -e ''s/__imageRepository__/$(imageRepository)/''  $(Pipeline.Workspace)/drop/kubedeployconfigs/kubedeployconfigs.yaml -e   ''s/__tag__/$(tag)/''  $(Pipeline.Workspace)/drop/kubedeployconfigs/kubedeployconfigs.yaml  -e ''s/__DbConnection__/"Server=tcp:samplejsptest.database.windows.net,1433;Initial Catalog=sampleapidb;Persist Security Info=False;User ID=jsp;Password=Password@123;MultipleActiveResultSets=False;Encrypt=True;TrustServerCertificate=False;Connection Timeout=30;"/''  $(Pipeline.Workspace)/drop/kubedeployconfigs/kubedeployconfigs.yaml
          - task: KubernetesManifest@0
            displayName: Deploy to Kubernetes cluster
            inputs:
              action: deploy
              manifests: |
                $(Pipeline.Workspace)/drop/kubedeployconfigs/kubedeployconfigs.yaml
              imagePullSecrets: |
                $(imagePullSecret)
              containers: |
                $(imageRepository):$(tag)

- stage: DBMigration
  displayName: DBMigration
  dependsOn: Build
  jobs:
  - job: Build
    displayName: Build
    pool:
      vmImage: windows-latest
    steps:
    - task: NuGetToolInstaller@1
      displayName: 'Install NuGet >=6.3.0-0'
      inputs:
        versionSpec: '>=6.3.0-0'
        checkLatest: true
    - task: NuGetCommand@2  
      displayName: 'Restore nuget packages' 
    - task: MSBuild@1
      displayName: 'Build the project'
    - task: DotNetCoreCLI@2
      displayName: 'Initialize EntityFrameworkCore'
      inputs:
        command: custom
        custom: tool
        arguments: 'install --global dotnet-ef --version 6.0.0'
    - task: UseDotNet@2
      displayName: Use .NET 6.0
      inputs:
        packageType: 'sdk'
        version: '6.0.x'
    - task: DotNetCoreCLI@2
      displayName: 'Create migration'
      inputs:
        command: custom
        custom: ef
        projects: 'Persistence'
        arguments: 'migrations script -i -o migration.sql' 
    - task: SqlAzureDacpacDeployment@1
      displayName: Install the database
      inputs:
        azureSubscription: 'sample-db-serv-conn'
        ServerName: 'samplejsptest'
        DatabaseName: 'sampleapidb'
        SqlUsername: 'jsp'
        SqlPassword: 'Password@123'
        DacpacFile: 'migration.sql'